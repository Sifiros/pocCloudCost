#!/usr/bin/python3

from TeevityAPI import TeevityAPI
from gainCalculator import GainCalculator
from dateutil.parser import *
from datetime import *
import json
import sys

def printEventTypeFromSavings(savings):
    for saving in savings:
        print(' SAVING = ' + str(saving))

def main():
    costsFilepath = sys.argv[1] if len(sys.argv) > 1 else "./api/costs.csv"
    eventsFilepath = sys.argv[2] if len(sys.argv) > 2 else "./api/events.csv"

    api = TeevityAPI(costsFilepath, eventsFilepath)
    PRINT = True#False if len(sys.argv) > 1 and sys.argv[1] == "--json" else True
    # try:
    calculator = GainCalculator(api.GetCostDatas(), api.GetEvents())
    # return 
    if PRINT:
        calculator.printCurrentScope()

    calculator.processEvents()
    savings = calculator.getSavings()
    
    if PRINT:
        calculator.printEventScopes()

    if PRINT:
        print('------------------ Savings by events : ')
        printEventTypeFromSavings(savings['savings'])
    else:
        print(json.dumps(savings))

    # except Exception as error:
    #      print("An error occured %s" % (error), file=sys.stderr)
    #      return (-1)
    # except KeyboardInterrupt:
    #      print ("\nSIGINT caught, interrupt program", file=sys.stderr)
    # except:
    #      print ("Unknown error occured", file=sys.stderr)
    return (0)

if __name__ == "__main__":
    sys.exit(main())
