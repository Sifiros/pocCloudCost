<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/locale/fr.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
<script type="text/javascript" src="./savingChart.js"></script>
<script type="text/javascript" src="./horizontalLineChartPlugin.js"></script>
<script type="text/javascript" src="./data.json"></script>

<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
</style>
<h1>Test</h1>
<div style="width:75%;">
    <canvas id="teevityChart"></canvas>
</div>
<center id="toggles">
</center>

<script>
        window.addMockDataset = function() {
            window.chart.addNewDataset({
                label: 'Mock',
                borderColor: 'grey',
                backgroundColor: 'blue'
            })
            window.chart.setDatasetPrices('Mock', [
                {date: '2017-08-08T09:00:00.000Z', price: '20'},
                {date: '2017-08-08T13:00:00.000Z', price: '30'},
                {date: '2017-08-08T17:00:00.000Z', price: '15'},
                {date: '2017-08-09T05:00:00.000Z', price: '22'},
                {date: '2017-08-09T12:30:00.000Z', price: '31'},
                {date: '2017-08-09T19:00:00.000Z', price: '27'},
            ]);
            window.chart.refresh();
        }

    window.onload = function() {
        registerPlugin('teevityChart');
        var metrics = datas
        var datasets = metricsToDatasets(metrics)
        window.chart = new TeevityChart('teevityChart', 'Teevity Savings', datasets)
        // window.addMockDataset();
        window.chart.refresh();

        for (var dataset of datasets) {
            var bt = document.createElement('button')
            const label = new String(dataset.label)
            console.log(' cur ' + label)
            bt.onclick = function() {
                console.log('clic on ' + label)
                window.chart.toggleDataset(label)
            }
            bt.appendChild(document.createTextNode(dataset.label))
            document.getElementById('toggles').appendChild(bt)
        }

        function metricsToDatasets(resources) {
            var datasets = []
            for (res in resources) {
                datasets.push({
                    label: res,
                    data: resources[res].prices,
                    fill: true
                });

                var lastUnoptimized = {};
                datasets.push({
                    label: ('Unoptimized ' + res),
                    data: resources[res].prices.map(function(cur) {
                        cur = Object.assign({}, cur)
                        if (!cur.matchingEventTypes)
                            lastUnoptimized = cur
                        else
                            cur.price = lastUnoptimized.price
                        return cur
                    }),
                    backgroundColor: 'transparent'
                    // fill: '-1'
                });
            }

            return datasets
        }

    }
</script>