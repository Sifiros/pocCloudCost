<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/locale/fr.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
<script type="text/javascript" src="./savingChart.js"></script>
<script type="text/javascript" src="./horizontalLineChartPlugin.js"></script>
<script type="text/javascript" src="./eventSavings.json"></script>
<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
</style>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<h1>Test</h1>
<div style="width:75%;">
    <canvas id="teevityChart"></canvas>
</div>

<!-- create a table with elems created by caussa -->

<div id="tableContainer">
        <table id="dataTable" class="table table-responsive table-sm table-striped"></table>
</div>

<script>

    window.onload = function() {
        registerPlugin('teevityChart');
        var datasets = Object.keys(datas.eventSavings).map(function(eventName) {
            return metricsToDataset(eventName, datas.eventSavings[eventName])
        })
        datasets.push(metricsToDataset('Total costs', datas.costs))
        window.chart = new TeevityChart('teevityChart', 'Teevity Savings', datasets)
        // window.addMockDataset();
        window.chart.refresh();

        function metricsToDataset(datasetName, resources) {
                return ({
                    label: datasetName,
                    data: resources.map(function (cur) {
                        cur.value = (typeof cur.saving != 'undefined' ? cur.saving : cur.costs);
                        return cur;
                    }),
                    fill: true
                });
            }
            var tabScopes = datas.eventScopes;
            var tableHead = "<tr><th>startDate</th>";
            tableHead += "<th>endDate</th>";
            tableHead += "<th>savings</th></tr></thead><tbody>";
            var totalEarned = 0;
            var earnedDuringCurrentCycle;
            var finalStr = ""

            // pour fix, faire des blocs dans la boucle, là ça stack toujours au début du coup on a une pile c'est moche sa race

            for (x in tabScopes) {
                earnedDuringCurrentCycle = 0;
                var strToAppend = ""
                tabScopes[x].forEach(function (item) {
                    totalEarned += item.totalSaving;
                    earnedDuringCurrentCycle += item.totalSaving;
                    strToAppend += "<tr><td>" + moment(item.startDate).format('MMMM Do YYYY, h:mm:ss a') + "</td>";
                    strToAppend += "<td>" + moment(item.endDate).format('MMMM Do YYYY, h:mm:ss a') + "</td>";
                    strToAppend += "<td>" + item.totalSaving + "</td></tr>";
                });
                finalStr += "<tr><th scope='row'>" + x + "</th><th>" + earnedDuringCurrentCycle + "</th></tr>" + strToAppend;
            }
            finalStr = "<thead><tr><td>" + "The total amount of Savings in this period is " + totalEarned + "</td></tr>" + tableHead + finalStr + "</tbody>";

            $('#dataTable').append(finalStr);
    }
</script>